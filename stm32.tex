% !TeX spellcheck = en_GB
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                        %
%    Engineer thesis LaTeX template      % 
%                                        %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\documentclass[a4paper,twoside,12pt]{book}
\usepackage[utf8]{inputenc}                                      
\usepackage[T1]{fontenc}  
\usepackage{amsmath,amsfonts,amssymb,amsthm}
% \usepackage[polish,british]{babel} 
\usepackage{indentfirst}
\usepackage{lmodern}
\usepackage{graphicx} 
\usepackage{hyperref}
\usepackage{booktabs}
% \usepackage{tikz}
% \usepackage{pgfplots}
\usepackage{mathtools}
\usepackage{geometry}
% \usepackage[page]{appendix} 
% \usepackage[style=authoryear,backend=biber]{biblatex}
% \usepackage[backend=bibtex,style=verbose-trad2]{biblatex}

\usepackage{setspace}
\onehalfspacing


\frenchspacing

\usepackage{listings}
\lstset{
	language={},
	basicstyle=\ttfamily,
	keywordstyle=\lst@ifdisplaystyle\color{blue}\fi,
	commentstyle=\color{gray}
}

%%%%%%%%%

 

%%%%%%%%%%%% FANCY HEADERS %%%%%%%%%%%%%%%

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LO]{\nouppercase{\it\rightmark}}
\fancyhead[RE]{\nouppercase{\it\leftmark}}
\fancyhead[LE,RO]{\it\thepage}


\fancypagestyle{onlyPageNumbers}{%
   \fancyhf{} 
   \fancyhead[LE,RO]{\it\thepage}
}

\fancypagestyle{PageNumbersChapterTitles}{%
   \fancyhf{} 
   \fancyhead[LO]{\nouppercase{\it\rightmark}}
   \fancyhead[RE]{\nouppercase{\it\leftmark}}
   \fancyhead[LE,RO]{\it\thepage}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%
% listings 
\usepackage{listings}
\lstset{%
language=C++,%
commentstyle=\textit,%
identifierstyle=\textsf,%
keywordstyle=\sffamily\bfseries, %\texttt, %
%captionpos=b,%
tabsize=3,%
frame=lines,%
numbers=left,%
numberstyle=\tiny,%
numbersep=5pt,%
breaklines=true,%
morekeywords={descriptor_gaussian,descriptor,partition,fcm_possibilistic,dataset,my_exception,exception,std,vector},%
escapeinside={@*}{*@},%
texcl=true, % wylacza tryb verbatim w komentarzach jednolinijkowych
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% % %%%% TODO LIST GENERATOR %%%%%%%%%

% % \usepackage{color}
% % \definecolor{brickred}      {cmyk}{0   , 0.89, 0.94, 0.28}

% % \makeatletter \newcommand \kslistofremarks{\section*{Remarks} \@starttoc{rks}}
% %   \newcommand\l@uwagas[2]
% %     {\par\noindent \textbf{#2:} %\parbox{10cm}
% % {#1}\par} \makeatother


% % \newcommand{\remark}[1]{%
% % {%\marginpar{\textdbend}
% % {\color{brickred}{[#1]}}}%
% % \addcontentsline{rks}{uwagas}{\protect{#1}}%
% % }

% % %%%%%%%%%%%%%% END OF TODO LIST GENERATOR %%%%%%%%%%% 

% % % some issues...

\newcounter{PagesWithoutNumbers}

\newcommand{\hcancel}[1]{%
    \tikz[baseline=(tocancel.base)]{
        \node[inner sep=0pt,outer sep=0pt] (tocancel) {#1};
        \draw[red] (tocancel.south west) -- (tocancel.north east);
    }%
}%

\newcommand{\MonthName}{%
  \ifcase\the\month
  \or January% 1
  \or February% 2
  \or March% 3
  \or April% 4
  \or May% 5
  \or June% 6
  \or July% 7
  \or August% 8
  \or September% 9
  \or October% 10
  \or November% 11
  \or December% 12
  \fi}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Helvetica font macros for the title page:
\newcommand{\headerfont}{\fontfamily{phv}\fontsize{18}{18}\bfseries\scshape\selectfont}
\newcommand{\titlefont}{\fontfamily{phv}\fontsize{18}{18}\selectfont}
\newcommand{\otherfont}{\fontfamily{phv}\fontsize{14}{14}\selectfont}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newcommand{\Author}{Michał Mieszczak}
\newcommand{\Supervisor}{Jerzy Fiołka, Dr Inż.}
\newcommand{\Consultant}{Name Surname, PhD}
\newcommand{\Title}{Realization of digital audio effects on high-performance MCU platform.}
\newcommand{\Polsl}{Silesian University of Technology}
\newcommand{\Faculty}{Faculty of Automatic Control, Electronics and Computer Science}


\begin{document} 
	
%%%%%%%%%%%%%%%%%%  Title page %%%%%%%%%%%%%%%%%%% 
\pagestyle{empty}
{
	\newgeometry{top=2.5cm,%
	             bottom=2.5cm,%
	             left=3cm,
	             right=2.5cm}
	\sffamily
	\rule{0cm}{0cm}
	
	\begin{center}
	\includegraphics[width=29mm]{polsl}
	\end{center} 
	\vspace{1cm}
	\begin{center}
	\headerfont \Polsl
	\end{center}
	\begin{center}
	\headerfont \Faculty
	\end{center}
	\vfill
	\begin{center}
	\titlefont Engineer  thesis
	\end{center}
	\vfill
	
	\begin{center}
	\otherfont \Title\par
	\end{center}
	
	\vfill
	
	\vfill
	 
	\noindent\vbox
	{
		\hbox{\otherfont Author: \Author}
		\vspace{12pt}
		\hbox{\otherfont Supervisor: \Supervisor}
		% \vspace{12pt}
		% \hbox{\otherfont consultant: \Consultant}
	}
	\vfill 
 
   \begin{center}
   \otherfont Gliwice,  \MonthName\ \the\year
   \end{center}	
   \restoregeometry
}
  

\cleardoublepage
 

\rmfamily
\normalfont


% \tableofcontents
% \newpage

%%%%%%%%%%%%%%%%%% Table of contents %%%%%%%%%%%%%%%%%%%%%%
\pagenumbering{Roman}
\pagestyle{onlyPageNumbers}
\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\setcounter{PagesWithoutNumbers}{\value{page}}
\mainmatter
\pagestyle{PageNumbersChapterTitles}








\chapter{Introduction}
The rapid development of technology lead to the moment, when anybody can afford a development board 
and learn how to program microcontrollers without even leaving house.
Hobbysts all around the world create products in wide range of applications, that can easily compete
with their professional counterparts in both price and quality.

One example of such a field is market of sound related equipment.
More and more small companies are growing out of nowhere,
providing butique studio recording and processing equipment with great customer service and support.



\chapter{Goals and tasks of the project}
The main goal of the project is to develop a platform based around modern, high-performance microcontroller.
The device should process stereo audio signal to achieve a selection of different effects.
To achieve decent audio quality at least 48kHz sampling frequency should be chosen.

Following tasks are required to finish the project:

\begin{enumerate}
    \item Choice of components
    \begin{itemize}
        \item microcontroller
        \item operational amplifiers
        \item additional devices
    \end{itemize}

    \item List of features
    \begin{itemize}
        \item list of audio effects
        \item user interface
    \end{itemize}

    \item Creating the physical layer of device
    \begin{itemize}
        \item block diagram
        \item schematic
        \item PCB
        \item assembly 
    \end{itemize}

    \item Developing software
    \begin{itemize}
        \item choosing programming language
        \item choosing IDE, text editor, toolchain and frameworks
        \item writing and testing the program (user interface, effects)
    \end{itemize}
\end{enumerate}




\chapter{Topic analysis}
This chapter is devoted to main concerns related to the project.

\section{Data acquisition}
The nature of audio signal is analog. This means,
that it should be conditioned in a proper way before it can be processed by digital circuitry.
It is done by ADC and coresponding preamplifier.

Signal must be reduced from continuous-time to discrete-time.
This process is called sampling and requires reading value of the signal in equal intervals of time.
Range of audible frequencies is considered to be 20Hz to 20kHz
and we need the whole range to acheive reasonable quality.
According to the concept of Nyquist frequency, the sampling frequency should be at least
twice as high as maximum frequency present in the signal.
In case of audio signal, it must be at leasu 40kHz.
There are some typical sampling frequencies preffered for audio signals such as: 44,1kHz, 48kHz,
96kHz, 192kHz and it would be a good idea to use one of them.

Furthermore ADC quantizes the value of the signal.
This means, that signal can take one of finite number of values.
The count of possible values is equal to \(2^n\), where n is the bit depth of the converter.

As stereo signal consists of two separate channels,
there sould be two identical preaplifiers and converters.


\section{Output generation}

\section{Processing audio}

\section{Effects}
\begin{itemize}
    \item
    \item
    \item
\end{itemize}




\chapter{External specification}

\section{Block diagram}

\section{Desctiption}
Device was designed in a form of a “shield” for NUCLEO development board.
The NUCLEO board provides a ST-Link programmer/debugger and voltage regulators required to power the board from 5V USB.
The shield is populated with analog and digital parts as well as two audio jacks for analog input and output.
Separate power lines and ground planes are used for digital and analog supply.

Device relays on both onboard digital to analog and analog to digital converters present in the microcontroller, so external preamplifiers are the only thing needed on the audio path.
Input preamplifier consist of two stages.
First stage acts as a buffer and provides about 14.5dB boost.
Boost is added to improve performance of converters.
At this point DC offset is added, because unipolar voltage supply was used.
The second stage is a basic phase inverter.
Outputs of both stages are fed into differential inputs of ADC and are sampled by microcontroller.
Output preamplifier consist of single inverting operational amplifier.
It provides -20dB attenuation necessary to achieve line level on output.
After output stage there is a 1.
5Hz high-pass filter, whose task is to eliminate DC offset.
Both input and output preamplifiers are stereo and introduce 20kHz low-pass filter to prevent aliasing and noise.
All 3 operational amplifiers are decoupled using a 100nF capacitor.

TFT LCD is used to provide necessary information to the user.
It is connected to the board using gold pin headers and sockets.
Display communicates with microcontroller through full duplex SPI connection.

To allow user to interact with the device, a rotary encoder was introduced.
It is connected to microcontroller and is handled by internal timer.
Push button of the encoder and additional user button are connected to GPIOs (General Purpose Input/Output) of the microcontroller.

Additionally  the board is equipped with 32MB SDRAM chip (only 16MB is accessible).
It is not used by the program of this project, but allows for future improvements.
SDRAM can be handled by FMC (Flexible Memory Controller) present in the microcontroller.
\newpage

\section{Choice of components}

\begin{itemize}
    \item Microcontroller
    The microcontroller should meet certain parameters to be chosen.
    One of the most important parameters is the clock speed.
    Digital signal processing requires a lot of processor instructions per each audio sample,
    so high clock speed is preferred.

    The second important criterion is amount of memory.
    The microcontroller should have at least 128kB of ROM to fit the written program.
    Size of RAM should be as high as possible, because delay effects require a lot of memory.

    Presence of FPU (floating-point unit) is preferred due to its performance benefits.

    To reduce the total cost of the device, proper A/D and D/A converters could be included in the microcontroller.

    All of above criterion is met by STM32H743ZI microcontroller.
    It is based on Arm Cortex-M7 32-bit RISC core.
    Most important parameters of this microcontroller are listed below:
    \begin{itemize}
        \item 480MHz maximum clock frequency
        \item 1MB of RAM and 2MB of Flash memory
        \item single and double precision FPU and set of DPS instructions
        \item 16-bit ADC and 12-bit DAC
        \item 140 I/Os and selection of peripherals such as hardware SPI, I2C, I2S, UART, SPDIF, USB OTG
    \end{itemize}

    The STM32H743ZI comes one the NUCLEO-H743ZI evaluation board.
    It includes ST-LINK debugger/programmer, which simplified development of the device. 
    \item Operational amplifiers
    \item Additional devices
\end{itemize}

\section{Schematic}
Schematic was created using KiCad EDA, which is both cross-platform and open source software.
It provides rich library of components and very intuitive user interface.

\section{PCB}
PCB layout was prepared using KiCad EDA as well.
All elements except for gold pin headers, rotary encoder and audio jacks are SMD (surface mounted).
To reduce cost of the project, the PCB was designed as 2 layer board only.
This decision resulted in increased difficulty of routing process.

\section{Assembly}
The PCB was assembled by hand using 50W soldering iron and hot air rework station.
\newpage



\chapter{Internal specification}

\section{Programming language}
C language is the most popular choice for STM32 development.
It is widely supported by ST and other companies providing frameworks and libraries. 

Since the object oriented approach was preferred in this project, C++ language was chosen.
It allows to benefit from libraries written in C and gives advantages of using classes with inheritance and polymorphism.

\section{IDE}
The popular environments for STM32 development are Keil uVision, IAR and SW4STM32.
ST also provides its own STM32CubeIDE, which is based on Eclipse.

But this time PlatformIO IDE was chosen.
It is open source IDE and comes as a plugin for Visual Studio Code and Atom text editors.
It provides all necessary libraries, frameworks, debugger server and GNU embedded toolchain for Arm.

\section{Text editor}
Visual Studio Code is a free code editor developed by Microsoft.
It was chosen because it is supported by PlatformIO IDE.
VSCode provides linting and word completion extensions,
which simplify the process of software development.

\section{Frameworks and tools}
List of frameworks and additional tools used for software development:

\begin{itemize}
    \item STM32CubeMX
    - a graphical tool that allows an easy STM32 configuration.
    It generates configuration code for the microcontroller and desired peripherals in C language.
    \item HAL drivers
    - (Hardware Abstraction Layer) driver is a library provided by ST.
    it allows an easy use of microcontroller and code compatibility between different STM32 devices.
    \item CMSIS
    - CMSIS (Cortex Microcontroller Software Interface Standard) is a hardware abstraction layer provided by Arm.
    It is compatible with all Arm Cortex microprocessors and microcontrollers.
    It includes API for Cortex-M and Cortex-A core and peripherals as well as additional tools
    (DSP library, neural network kernels, real-time operating systems).
\end{itemize}

\section{Software block diagram}

\section{Description of functions and objects}

\section{User manual}

\newpage



\chapter{Testing}

\newpage



\chapter{Conclusions}

\newpage



% \chapter{Bibliography}
% \begin{enumerate}
%     \item Udo Zölzer, DAFX: Digital Audio Effects, 2002 John Wiley \& Sons Ltd, ISBN: 0-470-84604-6
%     \item Udo Zölzer, Digital Audio Signal Processing, 2008 John Wiley \& Sons Ltd, ISBN: 978-0-470-99785-7
% \end{enumerate}
% \newpage



% \section{Attachments}

% \newpage



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\backmatter
\pagenumbering{Roman}
\stepcounter{PagesWithoutNumbers}
\setcounter{page}{\value{PagesWithoutNumbers}}

\pagestyle{onlyPageNumbers}

%%%%%%%%%%% bibliography %%%%%%%%%%%%
% \bibliographystyle{plain}
\bibliographystyle{ieeetr}
\bibliography{thebibliography}

%%%%%%%%%  appendices %%%%%%%%%%%%%%%%%%% 

% \begin{appendices} 

% \end{appendices}

 

% \chapter*{List of abbreviations and symbols}

% \begin{itemize}
% \item[DNA] deoxyribonucleic acid
% \item[MVC] model--view--controller 
% \item[$N$] cardinality of data set
% \item[$\mu$] membership function of a fuzzy set
% \item[$\mathbb{E}$] set of edges of a graph
% \item[$\mathcal{L}$] Laplace transformation
% \end{itemize}

\end{document}