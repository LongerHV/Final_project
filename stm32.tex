% !TeX spellcheck = en_GB
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                        %
%    Engineer thesis LaTeX template      % 
%                                        %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\documentclass[a4paper,twoside,12pt]{book}
\usepackage[utf8]{inputenc}                                      
\usepackage[T1]{fontenc}  
\usepackage{amsmath,amsfonts,amssymb,amsthm}
% \usepackage[polish,british]{babel} 
\usepackage{indentfirst}
\usepackage{lmodern}
\usepackage{graphicx} 
\usepackage{hyperref}
\usepackage{booktabs}
\usepackage{tikz}
\usepackage{pgfplots}
\usepackage{mathtools}
\usepackage{geometry}
\usepackage[page]{appendix} 
\usepackage[backend=bibtex]{biblatex}
\addbibresource{thebibliography.bib}

\usepackage{setspace}
\onehalfspacing


\frenchspacing

\usepackage{listings}
\lstset{
	language={},
	basicstyle=\ttfamily,
	keywordstyle=\lst@ifdisplaystyle\color{blue}\fi,
	commentstyle=\color{gray}
}

%%%%%%%%%

 

%%%%%%%%%%%% FANCY HEADERS %%%%%%%%%%%%%%%

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LO]{\nouppercase{\it\rightmark}}
\fancyhead[RE]{\nouppercase{\it\leftmark}}
\fancyhead[LE,RO]{\it\thepage}


\fancypagestyle{onlyPageNumbers}{%
   \fancyhf{} 
   \fancyhead[LE,RO]{\it\thepage}
}

\fancypagestyle{PageNumbersChapterTitles}{%
   \fancyhf{} 
   \fancyhead[LO]{\nouppercase{\it\rightmark}}
   \fancyhead[RE]{\nouppercase{\it\leftmark}}
   \fancyhead[LE,RO]{\it\thepage}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%
% listings 
\usepackage{listings}
\lstset{%
language=C++,%
commentstyle=\textit,%
identifierstyle=\textsf,%
keywordstyle=\sffamily\bfseries, %\texttt, %
%captionpos=b,%
tabsize=3,%
frame=lines,%
numbers=left,%
numberstyle=\tiny,%
numbersep=5pt,%
breaklines=true,%
morekeywords={descriptor_gaussian,descriptor,partition,fcm_possibilistic,dataset,my_exception,exception,std,vector},%
escapeinside={@*}{*@},%
texcl=true, % wylacza tryb verbatim w komentarzach jednolinijkowych
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% % %%%% TODO LIST GENERATOR %%%%%%%%%

% % \usepackage{color}
% % \definecolor{brickred}      {cmyk}{0   , 0.89, 0.94, 0.28}

% % \makeatletter \newcommand \kslistofremarks{\section*{Remarks} \@starttoc{rks}}
% %   \newcommand\l@uwagas[2]
% %     {\par\noindent \textbf{#2:} %\parbox{10cm}
% % {#1}\par} \makeatother


% % \newcommand{\remark}[1]{%
% % {%\marginpar{\textdbend}
% % {\color{brickred}{[#1]}}}%
% % \addcontentsline{rks}{uwagas}{\protect{#1}}%
% % }

% % %%%%%%%%%%%%%% END OF TODO LIST GENERATOR %%%%%%%%%%% 

% % % some issues...

\newcounter{PagesWithoutNumbers}

\newcommand{\hcancel}[1]{%
    \tikz[baseline=(tocancel.base)]{
        \node[inner sep=0pt,outer sep=0pt] (tocancel) {#1};
        \draw[red] (tocancel.south west) -- (tocancel.north east);
    }%
}%

\newcommand{\MonthName}{%
  \ifcase\the\month
  \or January% 1
  \or February% 2
  \or March% 3
  \or April% 4
  \or May% 5
  \or June% 6
  \or July% 7
  \or August% 8
  \or September% 9
  \or October% 10
  \or November% 11
  \or December% 12
  \fi}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Helvetica font macros for the title page:
\newcommand{\headerfont}{\fontfamily{phv}\fontsize{18}{18}\bfseries\scshape\selectfont}
\newcommand{\titlefont}{\fontfamily{phv}\fontsize{18}{18}\selectfont}
\newcommand{\otherfont}{\fontfamily{phv}\fontsize{14}{14}\selectfont}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newcommand{\Author}{Michał Mieszczak}
\newcommand{\Supervisor}{dr inż. Jerzy Fiołka}
\newcommand{\Consultant}{Name Surname, PhD}
\newcommand{\Title}{Realization of digital audio effects on high-performance MCU platform.}
\newcommand{\Polsl}{Silesian University of Technology}
\newcommand{\Faculty}{Faculty of Automatic Control, Electronics and Computer Science}


\begin{document} 
	
%%%%%%%%%%%%%%%%%%  Title page %%%%%%%%%%%%%%%%%%% 
\pagestyle{empty}
{
	\newgeometry{top=2.5cm,%
	             bottom=2.5cm,%
	             left=3cm,
	             right=2.5cm}
	\sffamily
	\rule{0cm}{0cm}
	
	\begin{center}
	\includegraphics[width=29mm]{polsl}
	\end{center} 
	\vspace{1cm}
	\begin{center}
	\headerfont \Polsl
	\end{center}
	\begin{center}
	\headerfont \Faculty
	\end{center}
	\vfill
	\begin{center}
	\titlefont Engineer  thesis
	\end{center}
	\vfill
	
	\begin{center}
	\otherfont \Title\par
	\end{center}
	
	\vfill
	
	\vfill
	 
	\noindent\vbox
	{
		\hbox{\otherfont Author: \Author}
		\vspace{12pt}
		\hbox{\otherfont Supervisor: \Supervisor}
		% \vspace{12pt}
		% \hbox{\otherfont consultant: \Consultant}
	}
	\vfill 
 
   \begin{center}
   \otherfont Gliwice,  \MonthName\ \the\year
   \end{center}	
   \restoregeometry
}
  

\cleardoublepage
 
\rmfamily
\normalfont

%%%%%%%%%%%%%%%%%% Table of contents %%%%%%%%%%%%%%%%%%%%%%
\pagenumbering{Roman}
\pagestyle{onlyPageNumbers}
\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\setcounter{PagesWithoutNumbers}{\value{page}}
\mainmatter
\pagestyle{PageNumbersChapterTitles}




\chapter{Introduction}
The rapid development of technology lead to the moment, when anybody can afford a development board 
and learn how to program microcontrollers without even leaving house.
Hobbysts all around the world create products in wide range of applications, that can easily compete
with their professional counterparts in both price and quality.

One example of such a field is market of sound related equipment.
More and more small companies are growing out of nowhere,
providing butique studio recording and processing equipment with great customer service and support.




\chapter{Goals and tasks of the project}
The main goal of the project is to develop a platform based around modern,
high-performance microcontroller.
The device should process stereo audio signal to achieve a selection of different effects
while delivering decent sound quality.
Following tasks are required to finish the project:

\begin{enumerate}
    \item Choice of components
    \begin{itemize}
        \item microcontroller
        \item operational amplifiers
        \item additional devices
    \end{itemize}

    \item List of features
    \begin{itemize}
        \item list of audio effects
        \item user interface
    \end{itemize}

    \item Creating the physical layer of device
    \begin{itemize}
        \item block diagram
        \item schematic
        \item PCB
        \item assembly 
    \end{itemize}

    \item Developing software
    \begin{itemize}
        \item choosing programming language
        \item choosing IDE, text editor, toolchain and frameworks
        \item writing and testing the program (user interface, effects)
    \end{itemize}
\end{enumerate}




\chapter{Topic analysis}
This chapter is devoted to main concerns related to the project,
that need to be considered at the beginning.
These will determine all important features and parameters of the device.

\section{Data acquisition}
The nature of audio signal is analog. This means,
that it should be conditioned in a proper way before it can be processed by digital circuitry.
It is done by ADC and coresponding preamplifier.

Signal must be reduced from continuous-time to discrete-time.
This process is called sampling and requires reading value of the signal in equal intervals of time.
Range of audible frequencies is considered to be 20Hz to 20kHz
and we need the whole range to acheive reasonable quality.
According to the concept of Nyquist frequency, the sampling frequency should be at least
twice as high as maximum frequency present in the signal.
In case of audio signal, it must be at leasu 40kHz.
There are some typical sampling frequencies preffered for audio signals such as: 44,1kHz, 48kHz,
96kHz, 192kHz and it would be a good idea to use one of them.

Furthermore ADC quantizes the value of the signal.
This means, that signal can take one of finite number of values.
The count of possible values is equal to \(2^n\), where n is the bit depth of the converter.

As stereo signal consists of two separate channels,
there sould be two identical sets of preaplifiers and converters.

\section{Output generation}
Processed digital signal must be converted back to analog.
This is done using DAC and corresponding amplifier.
DAC converts digital value into specific analog voltage,
outputs it and holds the value until succesive sample is to be outputted.

\section{Processing audio}
Digital signals are usually processed in blocks.
This approach allows to use FFT, which is necessary for some effects.
Furthermore it can reduce time needed to process each sample.
One drawback of this method is latency introduced.
The whole block of samples needs to be collected before it can be processed.
In case of blocks consisting of 512 samples,
there is 1024 samples delay between collecting and outputting specific sample.
In combination with 48kHz sampling frequency this results in 21.3 ms latency.
Outputting, processing and collecting subsequent blocks off data must be performed simultaneously.

\section{Effects}
This section is dedicated to audio effects implemented in the devices
as well as their features and parameters.
It is important to fully understand nature of specific effect
in order to implement it's entire functionality in a proper way.
\cite{Zolzer1}
\cite{Zolzer2}

\subsection{Delay}
Delay is the most basic time based effects.
It creates echo of original signal,
which is delayed by specified amount of time.
This delayed signal is then mixed with original.
Delayed signal can also be attenuated and then fed back into a delay block
in order to achieve endless, fading reflections.

Because processed signal is quantized,
delay time is described by number of samples.
Digital implementation of this effect requires use of circular buffer,
which size is determined by delay time required.
Each sample collected from input is stored in the buffer
in order to be read later and mixed to the output.

\subsection{Modulation}
Modulation effects use LFO to modulate different parameters.
Our attention will be focused on pitch modulation
which is based on delay effect and works by varying a delay time.
Modulation effects usually use short delay times up to 30ms
and LFO frequency up to several Hz.
Different functions, such as sine,
triangular or sawtooth can be used for LFO.
There are a few distinct modulation effects:
\begin{itemize}
    \item Chorus - uses delay time up to 20ms with LFO frequency up to 10Hz with medium depth.
    \item Flanger - simmilar to chorus, but uses shorter delay time and higher value of depth.
        Flanger effects also use feedback.
    \item Vibrato - is a different type of pitch modulation effect. It mutes original (dry) signal
        from the mix, leaving only modulated sound.
    \item Tremolo - in contrast to previous effects uses volume modulation instead of pitch modulation.
    \item Phaser - modulates phase of the signal. It is done with use of all-pass filters.
\end{itemize}

\subsection{Biquad filter}
Biquad (biquadratic) filter is a type of second order IIR digital filter.
The biquad filter is desctibed by 5 coefficients and exists in two direct forms.
The difference between them is that the direct form 1 uses four delay registers
while direct form 2 requires only two.
This is the reason why direct form 2 is considered to be canonical.
Use of proper formulas allows to implement biquad as one of many types of filters
including high-pass, low-pass, band-pass, peak, notch, high-shelf and low-shelf.
Filters are also described by parameters such as corner frequency, quality factor
and in some cases preak gain.
\cite{Biquad}
\cite{biquad_web}

\subsection{Drive}

\section{Display}
There are different ways to connect LCD to a microcontroller.
The most common is use of a parallel interface,
such as Intel 8080 or Motorola 6800.
These interfaces require 8 or 16 data lines,
alongside few other control signals.
Other approach involves use of serial interface,
such as SPI or I\(^2\)C.
It allows to reduce number of connections necessary to control the display,
but greatly decreases data transfer rate.

With connection between MCU and LCD established,
we can focus our attention on actually sending data to be displayed.
Common approach, seen in TV and computer monitors,
is to constantly refresh the screen pixel by pixel.
It involves sending huge amounts of data,
even if displayed picture does not change.
Since most of LCD units designed to be used with microcontrollers
contain their own controller as well as RAM,
constant refreshing is completely unnecessary.
Instead, controller allows selecting a rectangular portion
of screen, which is ment to be updated.
This way we can eliminate problem of wasting MCU performance
on resending the same data over and over.

Sometimes different vendors provide drivers for their displays.
Unfortunately they are usually implemented for Arduino
and use so called polling mode,
which blocks MCU for the time of data transfer.
It means that custom driver must be created for this project.


\chapter{External specification}

\section{Block diagram}

\section{Desctiption}
Device was designed in a form of a “shield” for NUCLEO development board.
The NUCLEO board provides a ST-Link programmer/debugger
and voltage regulators required to power the board from 5V USB.
The shield is populated with analog and digital parts
as well as two audio jacks for analog input and output.
Separate power lines and ground planes are used for digital and analog supply.

Device relays on both onboard digital to analog
and analog to digital converters present in the microcontroller,
so external preamplifiers are the only thing needed on the audio path.
Input preamplifier consist of two stages.
First stage acts as a buffer and provides about 14.5dB boost.
Boost is added to improve performance of converters.
At this point DC offset is added, because unipolar voltage supply was used.
The second stage is a basic phase inverter with unity gain.
Outputs of both stages are fed into differential inputs of ADC
and are sampled by microcontroller.

Output preamplifier consist of single inverting operational amplifier.
It provides -20dB attenuation necessary to achieve line level on output.
After output stage there is a 1.5Hz high-pass filter,
whose task is to eliminate DC offset.
Both input and output preamplifiers are stereo and introduce 20kHz low-pass filter
to prevent aliasing and noise.
All 3 operational amplifiers are decoupled using a 100nF capacitor.

TFT LCD is used to provide necessary information to the user.
It is connected to the board using gold pin headers and sockets.
Display communicates with microcontroller through full duplex SPI connection.

To allow user to interact with the device, a rotary encoder was introduced.
It is connected to microcontroller and is handled by internal timer.
Push button of the encoder and additional user button are connected
to GPIOs of the microcontroller with external pull-up resistors.

Additionally the board is equipped with 32MB SDRAM chip
(of which only 16MB is accessible).
It is not used by the program of this project, but allows for future improvements.
SDRAM is handled by FMC present in the microcontroller.
\newpage

\section{Choice of components}

\begin{itemize}
    \item Microcontroller

    The microcontroller should meet certain parameters to be chosen.
    One of the most important parameters is the clock speed.
    Digital signal processing requires a lot of processor instructions
    per each audio sample, so high clock speed is preferred.

    The second important criterion is amount of memory.
    The microcontroller should have at least 128kB of ROM
    to fit the written program.
    Size of RAM should be as high as possible,
    because delay effects require a lot of memory.

    Presence of FPU is preferred due to its performance benefits.
    Dedicated floating-point hardware greatly decreases time
    needed for floating-point calculations.

    To reduce the total cost of the device,
    proper A/D and D/A converters could be included in the microcontroller.

    All of above criterion is met by STM32H743ZI microcontroller.
    It is based on Arm Cortex-M7 32-bit RISC core.
    Most important parameters of this microcontroller are listed below:
    \begin{itemize}
        \item 480MHz maximum clock frequency
        \item 1MB of RAM and 2MB of Flash memory
        \item single and double precision FPU and set of DPS instructions
        \item 16-bit ADC and 12-bit DAC
        \item 140 I/Os and selection of peripherals such as hardware
        SPI, I2C, I2S, UART, SPDIF, USB OTG
    \end{itemize}

    The STM32H743ZI comes one the NUCLEO-H743ZI evaluation board.
    It includes ST-LINK debugger/programmer,
    which simplified development of the device. 
    \item Operational amplifiers
    \item Additional devices
\end{itemize}

\section{Schematic}
Schematic was created using KiCad EDA,
which is both cross-platform and open source software.
It provides rich library of components and very intuitive user interface.

\section{PCB}
PCB layout was prepared using KiCad EDA as well.
All elements except for gold pin headers,
rotary encoder and audio jacks are SMD (surface mounted).
To reduce cost of the project, the PCB was designed as 2 layer board only.
This decision resulted in increased difficulty of routing process.

\section{Assembly}
The PCB was assembled by hand using 50W soldering iron and hot air rework station.
\newpage



\chapter{Internal specification}

\section{Programming language}
C language is the most popular choice for STM32 development.
It is widely supported by ST and other companies providing frameworks and libraries. 

Since the object oriented approach was preferred in this project,
C++ language was chosen.
This allows to benefit from libraries written in C
and gives advantages of using classes with inheritance and polymorphism.

\section{IDE}
The popular environments for STM32 development are Keil uVision, IAR and SW4STM32.
ST also provides its own STM32CubeIDE, which is based on Eclipse.

Another choice is PlatformIO IDE.
It is free and open source IDE and
comes as a plugin for Visual Studio Code and Atom text editors.
It provides all libraries, frameworks,
debugger server and compiler necessary for STM32 software development.

\section{Text editor}
Visual Studio Code is a free code editor developed by Microsoft.
It was chosen because it is supported by PlatformIO IDE.
VSCode provides linting and word completion extensions,
which simplify the process of software development.

\section{Frameworks and tools}
List of frameworks and additional tools used for software development:

\begin{itemize}
    \item HAL drivers
    - Hardware Abstraction Layer driver is a library written in C language, provided by ST.
    It allows an easy use of microcontroller and code compatibility between different STM32 devices.
    \item STM32CubeMX
    - a graphical tool that allows an easy STM32 configuration.
    It generates configuration code for the microcontroller and desired peripherals in C language.
    STM32CubeMX uses HAL driver in generated initialization code.
    \item CMSIS
    - Cortex Microcontroller Software Interface Standard
    is a hardware abstraction layer provided by Arm.
    It is compatible with all Arm Cortex microprocessors and microcontrollers.
    It includes API for Cortex-M and Cortex-A core and peripherals as well as additional tools
    (DSP library, neural network kernels, real-time operating systems).
    \item OpenOCD
    - Open On-Chip Debugger provides programming and debugging support of boundary scan interface.
    It supports ST-Link, which was used for both programming and debugging of STM32 microcontroller.
    \item GNU Embedded Toolchain for Arm
    is a suite of tools for C, C++ and Assembly programming.
    It contains the GCC Compiler as well as linker.
\end{itemize}

\section{Software block diagram}

\section{Description of functions and objects}

\section{User manual}
To use the device it must be connected to a power source.
It requires 5V to be applied through the top USB port,
which can be provided by micro USB smartphone charger,
powerbank or directly from computer.

The device has two mini jack connectors on the bottom of the board.
Connector on the left is analog output for the signal source.
It can be connected to line output of smartphone or computer sound card.
Right connector is analog output and should be connected
to an audio amplifier or active speakers.

While powered, the LCD screen should light up
and display white text on black background.
In the left top corner, name of currently selected effect is presented.
Below we can see a list of all parameters,
which can affect behavior of the effect.
On the right of each parameter, there is presented its current value.
On the left side, there is an arrow,
which purpose is to indicate currently selected parameter.

User can interract with device using rotary encoder
as well as black and blue buttons.
Rotating knob changes currently selected parameter.
To modify value of chosen parameter, user must push the encoder
to activate edit mode. It is indicated by green color of text.
In edit mode use can rotate knob to modify chosen value
and press it one more time to accept changes.

To change active effect, user must rotate the encoder
while blue button is depressed. User can also reset the device if needed.
To do it, user can press the black button,
which a hardware reset for both microcontroller and LCD screen.

\newpage



\chapter{Testing}

\newpage


\chapter{Conclusions}

\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\backmatter
\pagenumbering{Roman}
\stepcounter{PagesWithoutNumbers}
\setcounter{page}{\value{PagesWithoutNumbers}}

\pagestyle{onlyPageNumbers}

%%%%%%%%%%% bibliography %%%%%%%%%%%%
\cite{ST:UM2407}
\printbibliography

%%%%%%%%%  appendices %%%%%%%%%%%%%%%%%%% 

% \begin{appendices} 

% \end{appendices}

 

\chapter*{List of abbreviations and symbols}

\begin{itemize}
\item[ADC] - Analog to digital converter
\item[API] - Application programming interface
\item[DAC] - Digital to analog converter
\item[DC] - Direct current
\item[DMA] - Direct memory access
\item[DSP] - Digital signal processing
\item[EDA] - Electronic design automation
\item[FFT] - Fast fourier transform
\item[FMC] - Flexible momory controller
\item[FPU] - Floating-point uint
\item[GCC] - GNU Compiler Collection
\item[GPIO] - General purpose input/output
\item[IDE] - Integrated development environment
\item[IIR] - Infinite impulse response
\item[LCD] - Liquid crystal display
\item[LFO] - Low frequency oscillator
\item[MCU] - Microcontroller Unit
\item[PCB] - Printed circuit board
\item[RAM] - Random access memory
\item[ROM] - Read only memory
\item[SDRAM] - Synchronous dynamic random access memory
\item[SMD] - Surface mounted device
% \item[$N$] cardinality of data set
% \item[$\mu$] membership function of a fuzzy set
% \item[$\mathbb{E}$] set of edges of a graph
% \item[$\mathcal{L}$] Laplace transformation
\end{itemize}

\end{document}
